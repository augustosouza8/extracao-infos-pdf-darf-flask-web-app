<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extrator de Informa√ß√µes DARF</title>
    <link
        rel="stylesheet"
        href="{{ url_for('static', filename='css/style.css') }}"
    />
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìÑ Extrator de Informa√ß√µes DARF</h1>
            <p class="subtitle">
                Envie um ou mais arquivos PDF de DARF e receba um arquivo Excel
                com as informa√ß√µes extra√≠das.
            </p>
        </header>

        {# Mensagens de feedback (flash) #}
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {# Mensagem de sucesso din√¢mica #}
        <div id="successMessage" class="success-message">
            <span class="success-icon">‚úì</span>
            <span class="success-text">Arquivo processado com sucesso! O download foi iniciado.</span>
            <button class="success-close" onclick="hideSuccessMessage()" aria-label="Fechar mensagem">√ó</button>
        </div>

        <section class="upload-container">
            <form
                action="{{ url_for('upload_files') }}"
                method="post"
                enctype="multipart/form-data"
                id="uploadForm"
            >
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìé</div>
                    <h3>Arraste e solte os arquivos PDF aqui</h3>
                    <p>Ou clique para selecionar arquivos</p>
                    <p style="font-size: 0.85rem; color: #888; margin-top: 4px;">Voc√™ pode selecionar v√°rios arquivos de uma vez</p>

                    <input
                        type="file"
                        name="files"
                        id="fileInput"
                        multiple
                        accept=".pdf"
                        required
                    />
                    <label for="fileInput" class="file-label">
                        Escolher arquivos
                    </label>

                    <div class="file-list" id="fileList"></div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span class="btn-text">Processar PDFs</span>
                        <span
                            class="btn-loader"
                            id="btnLoader"
                            style="display: none"
                        >
                            ‚è≥ Processando...
                        </span>
                    </button>

                    <button
                        type="button"
                        class="btn btn-secondary"
                        id="clearBtn"
                        style="display: none"
                    >
                        Limpar sele√ß√£o
                    </button>
                </div>
            </form>
        </section>

        <section class="info-box">
            <h3>‚ÑπÔ∏è Como usar:</h3>
            <ol>
                <li><strong>Arraste e solte</strong> os arquivos PDF na √°rea indicada, ou clique em <strong>"Escolher arquivos"</strong> para selecionar um ou mais PDFs de DARF.</li>
                <li>Clique em <strong>"Processar PDFs"</strong>.</li>
                <li>Aguarde o processamento.</li>
                <li>O navegador ir√° baixar um arquivo <code>resultado_darfs.xlsx</code>.</li>
            </ol>
        </section>

        <footer class="footer">
            <p>
                Desenvolvido para facilitar a extra√ß√£o de informa√ß√µes de DARF.
            </p>
        </footer>
    </div>

    <script>
        const fileInput = document.getElementById("fileInput");
        const fileList = document.getElementById("fileList");
        const clearBtn = document.getElementById("clearBtn");
        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.querySelector("#submitBtn .btn-text");
        const btnLoader = document.getElementById("btnLoader");
        const uploadForm = document.getElementById("uploadForm");
        const uploadArea = document.getElementById("uploadArea");
        const successMessage = document.getElementById("successMessage");

        function showSuccessMessage(fileCount) {
            const successText = successMessage.querySelector(".success-text");
            if (fileCount && fileCount > 0) {
                const fileWord = fileCount === 1 ? "arquivo" : "arquivos";
                successText.textContent = `${fileCount} ${fileWord} processado(s) com sucesso! O download foi iniciado.`;
            } else {
                successText.textContent = "Arquivo processado com sucesso! O download foi iniciado.";
            }
            successMessage.classList.add("show");
            // Esconde a mensagem automaticamente ap√≥s 5 segundos
            setTimeout(() => {
                hideSuccessMessage();
            }, 5000);
        }

        function hideSuccessMessage() {
            if (successMessage) {
                successMessage.classList.remove("show");
            }
        }

        // Torna a fun√ß√£o acess√≠vel globalmente para o bot√£o de fechar
        window.hideSuccessMessage = hideSuccessMessage;

        function updateFileList(files) {
            fileList.innerHTML = "";
            if (!files || files.length === 0) {
                clearBtn.style.display = "none";
                return;
            }

            Array.from(files).forEach((file) => {
                const item = document.createElement("div");
                item.className = "file-item";
                const sizeKb = (file.size / 1024).toFixed(1);
                item.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">(${sizeKb} KB)</span>
                `;
                fileList.appendChild(item);
            });

            clearBtn.style.display = "inline-flex";
        }

        function addFilesToInput(newFiles) {
            // Cria um DataTransfer para manipular os arquivos
            const dataTransfer = new DataTransfer();
            
            // Adiciona arquivos existentes do input (se houver)
            const existingFiles = fileInput.files;
            for (let i = 0; i < existingFiles.length; i++) {
                dataTransfer.items.add(existingFiles[i]);
            }
            
            // Adiciona os novos arquivos
            Array.from(newFiles).forEach((file) => {
                // Verifica se o arquivo j√° n√£o foi adicionado (evita duplicatas)
                let isDuplicate = false;
                for (let i = 0; i < existingFiles.length; i++) {
                    if (existingFiles[i].name === file.name && existingFiles[i].size === file.size) {
                        isDuplicate = true;
                        break;
                    }
                }
                
                if (!isDuplicate) {
                    dataTransfer.items.add(file);
                }
            });
            
            // Atualiza o input com todos os arquivos
            fileInput.files = dataTransfer.files;
            updateFileList(fileInput.files);
        }

        function filterPDFFiles(files) {
            return Array.from(files).filter((file) => {
                return file.type === "application/pdf" || file.name.toLowerCase().endsWith(".pdf");
            });
        }

        // Event listeners para drag and drop
        uploadArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add("drag-over");
        });

        uploadArea.addEventListener("dragleave", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove("drag-over");
        });

        uploadArea.addEventListener("drop", (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove("drag-over");
            
            const droppedFiles = e.dataTransfer.files;
            if (droppedFiles.length > 0) {
                const pdfFiles = filterPDFFiles(droppedFiles);
                
                if (pdfFiles.length === 0) {
                    alert("Por favor, arraste apenas arquivos PDF.");
                    return;
                }
                
                if (pdfFiles.length < droppedFiles.length) {
                    const nonPdfCount = droppedFiles.length - pdfFiles.length;
                    alert(`${nonPdfCount} arquivo(s) n√£o PDF foram ignorados. Apenas arquivos PDF s√£o aceitos.`);
                }
                
                addFilesToInput(pdfFiles);
            }
        });

        // Previne o comportamento padr√£o de arrastar sobre a p√°gina inteira
        document.addEventListener("dragover", (e) => {
            e.preventDefault();
        });

        document.addEventListener("drop", (e) => {
            e.preventDefault();
        });

        fileInput.addEventListener("change", (e) => {
            updateFileList(e.target.files);
        });

        clearBtn.addEventListener("click", () => {
            fileInput.value = "";
            updateFileList([]);
        });

        uploadForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            // Desabilita o bot√£o e mostra "Processando"
            btnText.style.display = "none";
            btnLoader.style.display = "inline-block";
            submitBtn.disabled = true;
            
            // Prepara o FormData
            const formData = new FormData(uploadForm);
            
            try {
                // Faz o upload via fetch
                const response = await fetch(uploadForm.action, {
                    method: "POST",
                    body: formData,
                    redirect: "follow",
                });
                
                // Verifica o tipo de conte√∫do da resposta
                const contentType = response.headers.get("content-type") || "";
                
                // Se a resposta √© HTML (erro com redirect), recarrega a p√°gina
                if (contentType.includes("text/html")) {
                    window.location.reload();
                    return;
                }
                
                // Se a resposta √© o arquivo Excel, faz o download
                if (contentType.includes("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet") ||
                    contentType.includes("application/octet-stream") ||
                    contentType.includes("application/vnd.ms-excel")) {
                    
                    // Obt√©m o arquivo como blob
                    const blob = await response.blob();
                    
                    // Obt√©m o nome do arquivo do header Content-Disposition ou usa o padr√£o
                    const contentDisposition = response.headers.get("content-disposition");
                    let filename = "resultado_darfs.xlsx";
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1].replace(/['"]/g, "");
                        }
                    }
                    
                    // Cria um link tempor√°rio para download
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Limpa o link tempor√°rio ap√≥s um pequeno delay
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }, 100);
                    
                    // Reseta o bot√£o e limpa os arquivos ap√≥s o download
                    btnText.style.display = "inline-block";
                    btnLoader.style.display = "none";
                    submitBtn.disabled = false;
                    // Guarda a quantidade de arquivos processados antes de limpar
                    const fileCount = fileInput.files.length;
                    
                    fileInput.value = "";
                    updateFileList([]);
                    
                    // Mostra mensagem de sucesso com a quantidade de arquivos
                    showSuccessMessage(fileCount);
                    
                } else {
                    // Tipo de conte√∫do n√£o reconhecido, recarrega para mostrar mensagem
                    window.location.reload();
                }
                
            } catch (error) {
                console.error("Erro ao processar arquivos:", error);
                // Em caso de erro, recarrega a p√°gina para mostrar mensagem de erro
                window.location.reload();
            }
        });
    </script>
</body>
</html>
